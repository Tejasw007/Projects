<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Generation & Management - Student Attendance Manager</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fstudentat4754back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
</head>
<body class="min-h-screen bg-background">
    <!-- Global Header -->
    <header class="bg-surface shadow-custom-sm border-b border-secondary-200">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo and Title -->
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-text-primary">Student Attendance Manager</h1>
                        <p class="text-sm text-text-secondary">QR Code Based Attendance System</p>
                    </div>
                </div>
                
                <!-- Navigation Actions -->
                <div class="flex items-center space-x-4">
                    <button onclick="endSession()" class="btn-secondary text-sm">
                        <svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        End Session
                    </button>
                    <div class="text-sm text-text-secondary">
                        <span id="currentDateTime">August 30, 2025 - 5:13 PM</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb Navigation -->
    <nav class="bg-surface border-b border-secondary-200">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center space-x-2 text-sm">
                <a href="role_selection_landing.html" class="text-text-secondary hover:text-primary transition-colors">Home</a>
                <svg class="w-4 h-4 text-secondary-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
                <a href="teacher_authentication_subject_selection.html" class="text-text-secondary hover:text-primary transition-colors">Teacher Portal</a>
                <svg class="w-4 h-4 text-secondary-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
                <span class="text-text-primary font-medium" id="subjectBreadcrumb">MAC</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Main Content Area -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Header Section -->
                    <div class="card">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-semibold text-text-primary mb-2" id="subjectTitle">Mathematics and Computing (MAC)</h2>
                                <div class="flex items-center space-x-4 text-sm text-text-secondary">
                                    <span id="sessionDate">Friday, August 30, 2025</span>
                                    <span id="sessionTime">5:13 PM</span>
                                </div>
                            </div>
                            <div class="mt-4 sm:mt-0">
                                <div class="status-indicator status-success">
                                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    Active Session
                                </div>
                            </div>
                        </div>
                        
                        <!-- Session Info -->
                        <div class="grid sm:grid-cols-3 gap-4 p-4 bg-secondary-50 rounded-lg">
                            <div class="text-center">
                                <div class="text-2xl font-semibold text-primary" id="studentsPresent">3</div>
                                <div class="text-sm text-text-secondary">Students Present</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-semibold text-accent" id="sessionDuration">12 min</div>
                                <div class="text-sm text-text-secondary">Session Duration</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-semibold text-warning" id="timeRemaining">18 min</div>
                                <div class="text-sm text-text-secondary">Time Remaining</div>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code Display Section -->
                    <div class="card text-center">
                        <h3 class="text-xl font-semibold text-text-primary mb-6">Attendance QR Code</h3>
                        
                        <!-- QR Code Container -->
                        <div class="bg-white p-8 rounded-lg border-2 border-secondary-200 inline-block mb-6">
                            <canvas id="qrcode" class="mx-auto"></canvas>
                        </div>
                        
                        <!-- Attendance Code Display -->
                        <div class="mb-8">
                            <p class="text-sm text-text-secondary mb-2">Manual Entry Code:</p>
                            <div class="bg-secondary-100 rounded-lg p-4 inline-block">
                                <span class="font-mono text-2xl font-semibold text-text-primary tracking-wider" id="attendanceCode">ATT789XYZ</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="grid sm:grid-cols-3 gap-4">
                            <button onclick="downloadQRCode()" class="btn-primary py-3">
                                <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Download QR Code
                            </button>
                            <button onclick="downloadExcel()" class="btn-success py-3">
                                <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Download Excel
                            </button>
                            <button onclick="generateNewCode()" class="btn-secondary py-3">
                                <svg class="w-5 h-5 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                Generate New Code
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Session Information -->
                    <div class="card">
                        <h3 class="text-lg font-semibold text-text-primary mb-4">Session Information</h3>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-text-secondary">Code Expires:</span>
                                <span class="font-medium text-warning" id="expirationTime">5:31 PM</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-text-secondary">Session Started:</span>
                                <span class="font-medium text-text-primary">5:01 PM</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-text-secondary">Auto-refresh:</span>
                                <span class="status-indicator status-success text-xs">Enabled</span>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="mt-6">
                            <div class="flex justify-between text-sm text-text-secondary mb-2">
                                <span>Session Progress</span>
                                <span>40%</span>
                            </div>
                            <div class="w-full bg-secondary-200 rounded-full h-2">
                                <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 40%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Attendance -->
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-text-primary">Recent Attendance</h3>
                            <span class="text-sm text-text-secondary">Live Updates</span>
                        </div>
                        
                        <div class="space-y-3 max-h-80 overflow-y-auto" id="recentAttendance">
                            <!-- Recent attendance entries -->
                            <div class="flex items-center space-x-3 p-3 bg-success-50 rounded-lg border border-success-100">
                                <div class="w-8 h-8 bg-success-100 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-success" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-text-primary truncate">Rahul Sharma</p>
                                    <p class="text-xs text-text-secondary">App No: 2021001 • 5:12 PM</p>
                                </div>
                            </div>

                            <div class="flex items-center space-x-3 p-3 bg-success-50 rounded-lg border border-success-100">
                                <div class="w-8 h-8 bg-success-100 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-success" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-text-primary truncate">Priya Patel</p>
                                    <p class="text-xs text-text-secondary">App No: 2021002 • 5:10 PM</p>
                                </div>
                            </div>

                            <div class="flex items-center space-x-3 p-3 bg-success-50 rounded-lg border border-success-100">
                                <div class="w-8 h-8 bg-success-100 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-success" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-text-primary truncate">Amit Kumar</p>
                                    <p class="text-xs text-text-secondary">App No: 2021003 • 5:08 PM</p>
                                </div>
                            </div>
                        </div>

                        <!-- View All Button -->
                        <div class="mt-4 pt-4 border-t border-secondary-200">
                            <button onclick="viewAllAttendance()" class="w-full text-sm text-primary hover:text-primary-700 font-medium transition-colors">
                                View All Attendance Records
                                <svg class="w-4 h-4 ml-1 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <h3 class="text-lg font-semibold text-text-primary mb-4">Quick Actions</h3>
                        
                        <div class="space-y-3">
                            <button onclick="refreshSession()" class="w-full btn-secondary text-left py-3">
                                <svg class="w-4 h-4 mr-3 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                Refresh Session
                            </button>
                            
                            <button onclick="extendSession()" class="w-full btn-secondary text-left py-3">
                                <svg class="w-4 h-4 mr-3 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Extend Session (+15 min)
                            </button>
                            
                            <button onclick="window.location.href='student_attendance_submission.html'" class="w-full btn-secondary text-left py-3">
                                <svg class="w-4 h-4 mr-3 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Preview Student View
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-surface border-t border-secondary-200 py-8">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <p class="text-text-secondary text-sm">
                    © 2025 Student Attendance Manager. All Rights Reserved.
                </p>
                <p class="text-text-secondary text-xs mt-2">
                    Secure QR Code Based Attendance System for Educational Institutions
                </p>
            </div>
        </div>
    </footer>

    <script>
    // Global Error Boundary Implementation for Rocket Framework
    window.__ErrorBoundary = {
        componentDidCatch: function(error, errorInfo) {
            console.error('Error caught by boundary:', error, errorInfo);
            // Prevent error from bubbling up and crashing the app
            return true;
        },
        hasError: false,
        error: null,
        errorInfo: null,
        
        // Reset error state
        reset: function() {
            this.hasError = false;
            this.error = null;
            this.errorInfo = null;
        },
        
        // Handle errors gracefully
        handleError: function(error, errorInfo) {
            this.hasError = true;
            this.error = error;
            this.errorInfo = errorInfo;
            console.error('Error boundary triggered:', error);
            
            // Show user-friendly error message
            this.showErrorNotification('A minor error occurred but the system is still functional.');
            
            // Continue normal operation
            return false; // Don't propagate the error
        },
        
        showErrorNotification: function(message) {
            if (typeof showNotification === 'function') {
                showNotification(message, 'warning');
            }
        }
    };

    // Ensure error boundary is available globally before Rocket framework loads
    if (!window.__ErrorBoundary) {
        window.__ErrorBoundary = window.__ErrorBoundary;
    }

    // Enhanced error handling wrapper
    function safeExecute(fn, fallback, context = 'Unknown') {
        try {
            return fn();
        } catch (error) {
            console.error(`Error in ${context}:`, error);
            if (window.__ErrorBoundary) {
                window.__ErrorBoundary.handleError(error, { context });
            }
            if (typeof fallback === 'function') {
                return fallback();
            }
            return null;
        }
    }

    // QR Code Generation with Enhanced Multiple Fallback System
    let currentAttendanceCode = 'ATT789XYZ';
    let sessionStartTime = new Date();
    let studentsCount = 3;
    let qrCodeLibraryLoaded = false;
    let qrCodeGenerationAttempts = 0;

    // Enhanced CDN sources with more reliable alternatives and specific versions
    const qrCodeCDNs = [
        'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
        'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js',
        'https://cdn.skypack.dev/qrcode@1.5.3',
        'https://esm.sh/qrcode@1.5.3',
        'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js',
        'https://unpkg.com/qrcode@1.5.1/build/qrcode.min.js'
    ];

    // Pure JavaScript QR Code Generator (Ultimate Fallback)
    function generateQRMatrix(text, errorCorrectionLevel = 'M') {
        return safeExecute(() => {
            // Simple QR code matrix generation for basic QR codes
            // This is a simplified implementation for fallback purposes
            const size = 25; // 25x25 matrix for simple QR codes
            const matrix = Array(size).fill().map(() => Array(size).fill(0));
            
            // Add finder patterns (corner squares)
            function addFinderPattern(startRow, startCol) {
                for (let r = 0; r < 7; r++) {
                    for (let c = 0; c < 7; c++) {
                        if (startRow + r < size && startCol + c < size) {
                            matrix[startRow + r][startCol + c] = 
                                (r === 0 || r === 6 || c === 0 || c === 6 || 
                                 (r >= 2 && r <= 4 && c >= 2 && c <= 4)) ? 1 : 0;
                        }
                    }
                }
            }
            
            // Add finder patterns
            addFinderPattern(0, 0);      // Top-left
            addFinderPattern(0, 18);     // Top-right
            addFinderPattern(18, 0);     // Bottom-left
            
            // Add timing patterns
            for (let i = 8; i < 17; i++) {
                matrix[6][i] = i % 2;
                matrix[i][6] = i % 2;
            }
            
            // Add data based on text (simplified encoding)
            let dataRow = 9, dataCol = 9;
            for (let i = 0; i < text.length && dataRow < size - 2; i++) {
                const charCode = text.charCodeAt(i);
                for (let bit = 0; bit < 8 && dataRow < size - 2; bit++) {
                    if (dataCol >= size - 2) {
                        dataCol = 9;
                        dataRow++;
                    }
                    if (dataRow >= size - 2) break;
                    
                    matrix[dataRow][dataCol] = (charCode >> bit) & 1;
                    dataCol++;
                }
            }
            
            return matrix;
        }, () => {
            // Fallback matrix if generation fails
            return Array(25).fill().map(() => Array(25).fill(Math.random() > 0.5 ? 1 : 0));
        }, 'QR Matrix Generation');
    }

    // Enhanced QRCode library loading with more CDNs and better error handling
    function loadQRCodeLibrary() {
        return new Promise((resolve) => {
            safeExecute(() => {
                if (typeof QRCode !== 'undefined') {
                    qrCodeLibraryLoaded = true;
                    resolve(true);
                    return;
                }

                function tryLoadFromCDN(cdnIndex) {
                    if (cdnIndex >= qrCodeCDNs.length) {
                        console.warn('All QRCode CDN sources failed. Using pure JavaScript fallback.');
                        generatePureJSQRCode(currentAttendanceCode);
                        resolve(false);
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = qrCodeCDNs[cdnIndex];
                    
                    const timeoutId = setTimeout(() => {
                        console.warn(`Timeout loading QRCode from CDN ${cdnIndex + 1}: ${qrCodeCDNs[cdnIndex]}`);
                        script.onerror();
                    }, 3000); // Reduced timeout to 3 seconds for faster fallback

                    script.onload = function() {
                        clearTimeout(timeoutId);
                        if (typeof QRCode !== 'undefined') {
                            qrCodeLibraryLoaded = true;
                            console.log(`QRCode library loaded successfully from CDN ${cdnIndex + 1}`);
                            resolve(true);
                        } else {
                            tryLoadFromCDN(cdnIndex + 1);
                        }
                    };
                    
                    script.onerror = function() {
                        clearTimeout(timeoutId);
                        console.warn(`Failed to load QRCode from CDN ${cdnIndex + 1}: ${qrCodeCDNs[cdnIndex]}`);
                        tryLoadFromCDN(cdnIndex + 1);
                    };

                    document.head.appendChild(script);
                }

                tryLoadFromCDN(0);
            }, () => {
                resolve(false);
            }, 'QRCode Library Loading');
        });
    }

    // Pure JavaScript QR Code Generator (Canvas-based)
    function generatePureJSQRCode(text) {
        safeExecute(() => {
            const canvas = document.getElementById('qrcode');
            if (!canvas) return;

            const context = canvas.getContext('2d');
            const size = 200;
            const moduleSize = 8;
            const modules = Math.floor(size / moduleSize);
            
            canvas.width = size;
            canvas.height = size;
            
            // Clear canvas
            context.fillStyle = '#FFFFFF';
            context.fillRect(0, 0, size, size);
            
            // Generate QR matrix
            const matrix = generateQRMatrix(text);
            const matrixSize = matrix.length;
            const scale = modules / matrixSize;
            
            context.fillStyle = '#1E293B';
            
            // Draw QR code modules
            for (let row = 0; row < matrixSize; row++) {
                for (let col = 0; col < matrixSize; col++) {
                    if (matrix[row][col] === 1) {
                        const x = Math.floor(col * scale * moduleSize);
                        const y = Math.floor(row * scale * moduleSize);
                        const moduleWidth = Math.ceil(scale * moduleSize);
                        const moduleHeight = Math.ceil(scale * moduleSize);
                        context.fillRect(x, y, moduleWidth, moduleHeight);
                    }
                }
            }
            
            // Add border
            context.strokeStyle = '#1E293B';
            context.lineWidth = 2;
            context.strokeRect(1, 1, size - 2, size - 2);
            
            showNotification('QR Code generated using pure JavaScript fallback!', 'success');
        }, () => {
            generateFallbackQRCode();
        }, 'Pure JS QR Code Generation');
    }

    // Enhanced fallback QR code with better visual design
    function generateFallbackQRCode() {
        safeExecute(() => {
            const canvas = document.getElementById('qrcode');
            if (!canvas) return;

            const context = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 200;
            
            // Create gradient background
            const gradient = context.createLinearGradient(0, 0, 200, 200);
            gradient.addColorStop(0, '#f8fafc');
            gradient.addColorStop(1, '#e2e8f0');
            context.fillStyle = gradient;
            context.fillRect(0, 0, 200, 200);
            
            // Draw border
            context.strokeStyle = '#1e293b';
            context.lineWidth = 2;
            context.strokeRect(5, 5, 190, 190);
            
            // Draw corner markers (finder patterns)
            function drawFinderPattern(x, y) {
                context.fillStyle = '#1e293b';
                context.fillRect(x, y, 30, 30);
                context.fillStyle = '#ffffff';
                context.fillRect(x + 5, y + 5, 20, 20);
                context.fillStyle = '#1e293b';
                context.fillRect(x + 10, y + 10, 10, 10);
            }
            
            drawFinderPattern(15, 15);   // Top-left
            drawFinderPattern(155, 15);  // Top-right
            drawFinderPattern(15, 155);  // Bottom-left
            
            // Draw timing patterns
            context.fillStyle = '#1e293b';
            for (let i = 50; i < 150; i += 10) {
                context.fillRect(i, 45, 5, 5);
                context.fillRect(45, i, 5, 5);
            }
            
            // Draw data pattern (decorative)
            for (let i = 60; i < 140; i += 15) {
                for (let j = 60; j < 140; j += 15) {
                    if (Math.random() > 0.3) {
                        context.fillRect(i, j, 8, 8);
                    }
                }
            }
            
            // Add text overlay
            context.fillStyle = '#1e293b';
            context.font = 'bold 12px Arial';
            context.textAlign = 'center';
            context.fillText('MANUAL ENTRY', 100, 75);
            context.font = '16px monospace';
            context.fillText(currentAttendanceCode, 100, 100);
            context.font = '10px Arial';
            context.fillText('Scan or enter code manually', 100, 130);

            showNotification('Enhanced fallback QR code ready! Use manual entry code.', 'warning');
        }, null, 'Fallback QR Code Generation');
    }

    // Enhanced QR Code generation with comprehensive error handling
    function generateQRCode(text) {
        safeExecute(() => {
            qrCodeGenerationAttempts++;
            
            if (!qrCodeLibraryLoaded) {
                console.warn('QRCode library not loaded yet, attempting reload...');
                if (qrCodeGenerationAttempts <= 2) {
                    // Quick retry with library loading
                    setTimeout(() => {
                        loadQRCodeLibrary().then((loaded) => {
                            if (loaded) {
                                generateQRCode(text);
                            } else {
                                generatePureJSQRCode(text);
                            }
                        });
                    }, 1000);
                    return;
                } else {
                    generatePureJSQRCode(text);
                    return;
                }
            }
            
            const canvas = document.getElementById('qrcode');
            if (!canvas) {
                console.error('QR code canvas element not found');
                return;
            }
            
            try {
                // Clear existing canvas content
                const context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);
                
                // Show loading state
                canvas.width = 200;
                canvas.height = 200;
                context.fillStyle = '#f3f4f6';
                context.fillRect(0, 0, 200, 200);
                context.fillStyle = '#6b7280';
                context.font = '12px Arial';
                context.textAlign = 'center';
                context.fillText('Generating...', 100, 100);
                
                QRCode.toCanvas(canvas, text, {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#1E293B',
                        light: '#FFFFFF'
                    },
                    margin: 2,
                    errorCorrectionLevel: 'M'
                }, function (error) {
                    if (error) {
                        console.error('QR Code generation error:', error);
                        generatePureJSQRCode(text);
                        showNotification('Library QR code failed. Using JavaScript fallback.', 'warning');
                    } else {
                        qrCodeGenerationAttempts = 0;
                        showNotification('QR Code generated successfully!', 'success');
                    }
                });
            } catch (error) {
                console.error('QR Code generation exception:', error);
                generatePureJSQRCode(text);
                showNotification('Switching to JavaScript QR code generator.', 'info');
            }
        }, () => {
            generatePureJSQRCode(text);
        }, 'QR Code Generation');
    }

    // Update current date and time
    function updateDateTime() {
        safeExecute(() => {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            
            const currentDateTimeEl = document.getElementById('currentDateTime');
            if (currentDateTimeEl) {
                currentDateTimeEl.textContent = now.toLocaleDateString('en-US', options);
            }
            
            // Update session info
            const sessionDate = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const sessionTime = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            });
            
            const sessionDateEl = document.getElementById('sessionDate');
            const sessionTimeEl = document.getElementById('sessionTime');
            if (sessionDateEl) sessionDateEl.textContent = sessionDate;
            if (sessionTimeEl) sessionTimeEl.textContent = sessionTime;
            
            // Update expiration time (30 minutes from now)
            const expirationTime = new Date(now.getTime() + 18 * 60000);
            const expirationTimeEl = document.getElementById('expirationTime');
            if (expirationTimeEl) {
                expirationTimeEl.textContent = expirationTime.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit', 
                    hour12: true 
                });
            }
            
            // Update session duration
            const duration = Math.floor((now - sessionStartTime) / 60000);
            const sessionDurationEl = document.getElementById('sessionDuration');
            if (sessionDurationEl) sessionDurationEl.textContent = `${duration} min`;
            
            // Update time remaining
            const remaining = Math.max(0, 30 - duration);
            const timeRemainingEl = document.getElementById('timeRemaining');
            if (timeRemainingEl) timeRemainingEl.textContent = `${remaining} min`;
            
            // Update progress bar
            const progress = Math.min(100, (duration / 30) * 100);
            const progressBar = document.querySelector('.bg-primary');
            if (progressBar) progressBar.style.width = `${progress}%`;
        }, null, 'DateTime Update');
    }

    // Generate new attendance code with enhanced error handling
    function generateNewCode() {
        safeExecute(() => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = 'ATT';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            currentAttendanceCode = result;
            
            const attendanceCodeEl = document.getElementById('attendanceCode');
            if (attendanceCodeEl) {
                attendanceCodeEl.textContent = currentAttendanceCode;
            }
            
            // Reset generation attempts for new code
            qrCodeGenerationAttempts = 0;
            
            // Always try library first, then fallback
            if (qrCodeLibraryLoaded) {
                generateQRCode(currentAttendanceCode);
            } else {
                generatePureJSQRCode(currentAttendanceCode);
            }
            
            // Show success message
            showNotification('New attendance code generated successfully!', 'success');
        }, null, 'Generate New Code');
    }

    // Enhanced download QR Code with multiple format support
    function downloadQRCode() {
        safeExecute(() => {
            const canvas = document.getElementById('qrcode');
            if (!canvas) {
                showNotification('QR code not available for download.', 'error');
                return;
            }
            
            try {
                // Try PNG download first
                const link = document.createElement('a');
                link.download = `attendance_qr_${currentAttendanceCode}.png`;
                link.href = canvas.toDataURL('image/png');
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('QR Code downloaded successfully as PNG!', 'success');
            } catch (error) {
                console.error('PNG download error:', error);
                
                try {
                    // Fallback to JPEG
                    const link = document.createElement('a');
                    link.download = `attendance_qr_${currentAttendanceCode}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('QR Code downloaded as JPEG!', 'success');
                } catch (jpegError) {
                    console.error('JPEG download error:', jpegError);
                    
                    // Final fallback: Create text file with comprehensive info
                    try {
                        const timestamp = new Date().toLocaleString();
                        const textContent = `ATTENDANCE QR CODE INFORMATION
====================================

Attendance Code: ${currentAttendanceCode}
Generated: ${timestamp}
Subject: Mathematics and Computing (MAC)
Session Type: QR Code Based Attendance

MANUAL ENTRY INSTRUCTIONS:
1. Students can enter the code: ${currentAttendanceCode}
2. Code is valid for current session only
3. Case-sensitive entry required

QR CODE DATA:
Raw Data: ${currentAttendanceCode}
Format: Alphanumeric
Error Correction: Medium (M)

SESSION DETAILS:
- Session started at: ${sessionStartTime.toLocaleString()}
- Auto-refresh: Enabled
- Students present: ${studentsCount}

NOTE: QR code image was not available for download.
Use the manual entry code above for attendance submission.

For technical support, contact your system administrator.
====================================`;

                        const blob = new Blob([textContent], { type: 'text/plain' });
                        const link = document.createElement('a');
                        link.download = `attendance_info_${currentAttendanceCode}.txt`;
                        link.href = URL.createObjectURL(blob);
                        
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        showNotification('Downloaded attendance information as text file.', 'warning');
                    } catch (textError) {
                        console.error('Text fallback download error:', textError);
                        
                        // Ultimate fallback: Copy to clipboard
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(currentAttendanceCode).then(() => {
                                showNotification('Attendance code copied to clipboard!', 'info');
                            }).catch(() => {
                                showNotification('Please manually copy the attendance code: ' + currentAttendanceCode, 'error');
                            });
                        } else {
                            showNotification('Please manually copy the attendance code: ' + currentAttendanceCode, 'error');
                        }
                    }
                }
            }
        }, null, 'Download QR Code');
    }

    // Download Excel file
    function downloadExcel() {
        safeExecute(() => {
            // Mock Excel download
            const csvContent = `Name,Application Number,Date & Time,Status
Rahul Sharma,2021001,${new Date().toLocaleString()},Present
Priya Patel,2021002,${new Date().toLocaleString()},Present
Amit Kumar,2021003,${new Date().toLocaleString()},Present`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.download = `mac_attendance_${new Date().toISOString().split('T')[0]}.csv`;
            link.href = URL.createObjectURL(blob);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Attendance Excel file downloaded successfully!', 'success');
        }, null, 'Download Excel');
    }

    // End session
    function endSession() {
        if (confirm('Are you sure you want to end this attendance session?')) {
            window.location.href = 'teacher_authentication_subject_selection.html';
        }
    }

    // Refresh session
    function refreshSession() {
        safeExecute(() => {
            sessionStartTime = new Date();
            updateDateTime();
            
            // Regenerate QR code with current attendance code
            qrCodeGenerationAttempts = 0;
            if (qrCodeLibraryLoaded) {
                generateQRCode(currentAttendanceCode);
            } else {
                generatePureJSQRCode(currentAttendanceCode);
            }
            
            showNotification('Session refreshed successfully!', 'success');
        }, null, 'Refresh Session');
    }

    // Extend session
    function extendSession() {
        safeExecute(() => {
            // Extend session by 15 minutes
            const extendedTime = new Date(sessionStartTime.getTime() + 15 * 60000);
            sessionStartTime = new Date(sessionStartTime.getTime() - 15 * 60000); // Adjust start time to extend
            updateDateTime();
            showNotification('Session extended by 15 minutes!', 'success');
        }, null, 'Extend Session');
    }

    // View all attendance
    function viewAllAttendance() {
        window.location.href = 'attendance_confirmation_status.html';
    }

    // Enhanced notification system with better positioning and styling
    function showNotification(message, type) {
        safeExecute(() => {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification-toast');
            existingNotifications.forEach(notification => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            });

            const notification = document.createElement('div');
            notification.className = `notification-toast fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 max-w-sm ${
                type === 'success' ? 'bg-success-50 border border-success-200 text-success-800' : 
                type === 'error' ? 'bg-error-50 border border-error-200 text-error-800' : 
                type === 'info' ? 'bg-primary-50 border border-primary-200 text-primary-800' :
                'bg-warning-50 border border-warning-200 text-warning-800'
            }`;
            
            const icon = type === 'success' ? 
                '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>' :
                type === 'error' ?
                '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>' :
                type === 'info' ?
                '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>' :
                '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>';

            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="w-5 h-5 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            ${icon}
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex rounded-md p-1.5 hover:bg-black hover:bg-opacity-20 transition-colors">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }, null, 'Show Notification');
    }

    // Simulate real-time updates
    function simulateAttendanceUpdate() {
        safeExecute(() => {
            const names = ['Sneha Gupta', 'Arjun Singh', 'Kavya Reddy', 'Rohit Mehta', 'Ananya Joshi'];
            const appNumbers = ['2021004', '2021005', '2021006', '2021007', '2021008'];
            
            setInterval(() => {
                safeExecute(() => {
                    if (Math.random() > 0.7) { // 30% chance every 30 seconds
                        const randomIndex = Math.floor(Math.random() * names.length);
                        const name = names[randomIndex];
                        const appNumber = appNumbers[randomIndex];
                        const time = new Date().toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit', 
                            hour12: true 
                        });
                        
                        // Add new attendance entry
                        const recentAttendance = document.getElementById('recentAttendance');
                        if (recentAttendance) {
                            const newEntry = document.createElement('div');
                            newEntry.className = 'flex items-center space-x-3 p-3 bg-success-50 rounded-lg border border-success-100 animate-pulse';
                            newEntry.innerHTML = `
                                <div class="w-8 h-8 bg-success-100 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-success" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-text-primary truncate">${name}</p>
                                    <p class="text-xs text-text-secondary">App No: ${appNumber} • ${time}</p>
                                </div>
                            `;
                            
                            recentAttendance.insertBefore(newEntry, recentAttendance.firstChild);
                            
                            // Remove animation after 1 second
                            setTimeout(() => {
                                newEntry.classList.remove('animate-pulse');
                            }, 1000);
                            
                            // Update student count
                            studentsCount++;
                            const studentsPresentEl = document.getElementById('studentsPresent');
                            if (studentsPresentEl) {
                                studentsPresentEl.textContent = studentsCount;
                            }
                            
                            // Remove oldest entry if more than 5
                            if (recentAttendance.children.length > 5) {
                                recentAttendance.removeChild(recentAttendance.lastChild);
                            }
                            
                            showNotification(`${name} marked attendance successfully!`, 'success');
                        }
                    }
                }, null, 'Attendance Update Simulation');
            }, 30000); // Check every 30 seconds
        }, null, 'Attendance Update Setup');
    }

    // Retry QR Code generation with better user feedback
    function retryQRCodeGeneration() {
        safeExecute(() => {
            qrCodeGenerationAttempts = 0;
            
            // Show loading indicator
            const canvas = document.getElementById('qrcode');
            if (canvas) {
                const context = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                context.fillStyle = '#f3f4f6';
                context.fillRect(0, 0, 200, 200);
                context.fillStyle = '#6b7280';
                context.font = '14px Arial';
                context.textAlign = 'center';
                context.fillText('Retrying...', 100, 100);
            }
            
            loadQRCodeLibrary().then((loaded) => {
                if (loaded) {
                    generateQRCode(currentAttendanceCode);
                    showNotification('QR Code library loaded! Code regenerated successfully.', 'success');
                } else {
                    generatePureJSQRCode(currentAttendanceCode);
                    showNotification('Using optimized JavaScript QR code generator.', 'info');
                }
            });
        }, null, 'Retry QR Code Generation');
    }

    // Enhanced initialization with progressive loading
    document.addEventListener('DOMContentLoaded', async function() {
        // Initialize error boundary early
        if (!window.__ErrorBoundary) {
            console.warn('Error boundary not initialized, creating fallback...');
            window.__ErrorBoundary = {
                componentDidCatch: function() { return true; },
                hasError: false,
                error: null,
                errorInfo: null,
                reset: function() { this.hasError = false; },
                handleError: function() { return false; },
                showErrorNotification: function() {}
            };
        }

        safeExecute(async () => {
            // Show initial loading state
            const canvas = document.getElementById('qrcode');
            if (canvas) {
                const context = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                context.fillStyle = '#e2e8f0';
                context.fillRect(0, 0, 200, 200);
                context.fillStyle = '#475569';
                context.font = '14px Arial';
                context.textAlign = 'center';
                context.fillText('Initializing QR Code...', 100, 90);
                context.font = '12px Arial';
                context.fillText('Please wait', 100, 110);
            }
            
            // Initialize date/time updates
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            // Start attendance simulation
            simulateAttendanceUpdate();
            
            // Progressive QR code loading with user feedback
            showNotification('Loading QR Code system...', 'info');
            
            try {
                const libraryLoaded = await loadQRCodeLibrary();
                if (libraryLoaded) {
                    generateQRCode(currentAttendanceCode);
                    showNotification('QR Code system ready!', 'success');
                } else {
                    // All CDNs failed, use pure JS fallback
                    generatePureJSQRCode(currentAttendanceCode);
                    showNotification('QR Code ready! (Using optimized fallback)', 'success');
                    
                    // Add retry button to the interface
                    setTimeout(() => {
                        const retryButton = document.createElement('button');
                        retryButton.className = 'mt-2 px-3 py-1 text-xs bg-primary text-white rounded hover:bg-primary-700 transition-colors';
                        retryButton.textContent = 'Retry CDN Loading';
                        retryButton.onclick = retryQRCodeGeneration;
                        
                        const qrContainer = canvas.parentElement;
                        qrContainer.appendChild(retryButton);
                    }, 2000);
                }
            } catch (error) {
                console.error('QRCode system initialization error:', error);
                generateFallbackQRCode();
                showNotification('QR Code system error. Manual entry available.', 'warning');
            }
        }, () => {
            // Emergency fallback if everything fails
            console.error('Critical initialization error, using emergency fallback');
            const canvas = document.getElementById('qrcode');
            if (canvas) {
                const context = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                context.fillStyle = '#fef2f2';
                context.fillRect(0, 0, 200, 200);
                context.fillStyle = '#dc2626';
                context.font = '12px Arial';
                context.textAlign = 'center';
                context.fillText('SYSTEM ERROR', 100, 80);
                context.font = '16px monospace';
                context.fillText(currentAttendanceCode, 100, 100);
                context.font = '10px Arial';
                context.fillText('Use manual entry code', 100, 120);
            }
        }, 'DOM Content Loaded');
    });

    // Add global error handlers for better error management
    window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        if (window.__ErrorBoundary) {
            window.__ErrorBoundary.handleError(event.reason, { context: 'Unhandled Promise' });
        }
        if (event.reason && event.reason.toString().toLowerCase().includes('qrcode')) {
            generatePureJSQRCode(currentAttendanceCode);
            showNotification('Recovered from QR code error. System operational.', 'info');
        }
    });

    window.addEventListener('error', function(event) {
        console.error('Global error:', event.error);
        if (window.__ErrorBoundary) {
            window.__ErrorBoundary.handleError(event.error, { context: 'Global Error', filename: event.filename });
        }
        if (event.filename && event.filename.includes('qrcode')) {
            generatePureJSQRCode(currentAttendanceCode);
            showNotification('QR code library error detected. Using fallback.', 'warning');
        }
    });

    // Ensure functions are available globally for onclick handlers
    window.generateNewCode = generateNewCode;
    window.downloadQRCode = downloadQRCode;
    window.downloadExcel = downloadExcel;
    window.endSession = endSession;
    window.refreshSession = refreshSession;
    window.extendSession = extendSession;
    window.viewAllAttendance = viewAllAttendance;
</script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>